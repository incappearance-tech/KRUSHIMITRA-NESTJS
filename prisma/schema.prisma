// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  FARMER
  LABOUR
  TRANSPORTER
  GUEST
}

enum ListingType {
  SELL
  RENT
}

enum ListingStatus {
  AVAILABLE
  SOLD
  IN_RENT
}

model User {
  id                String      @id @default(uuid())
  phoneNumber       String      @unique
  name              String?
  role              UserRole    @default(GUEST)
  locationLat       Float?
  locationLng       Float?
  locationAddress   String?     // Added for formatted address
  preferredLanguage String      @default("en")
  isVerified        Boolean     @default(false)
  fcmToken          String?     // For mobile push notifications
  deviceOS          String?     // 'android' or 'ios'
  
  // DPDP Act Compliance Fields
  privacyConsent    Boolean     @default(false)
  consentTimestamp  DateTime?
  deletedAt         DateTime?   // For "Right to Erasure" (Soft Delete)
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  
  // Relations
  listings          Machine[]
  ordersAsBuyer     Order[]     @relation("BuyerOrders")
  ordersAsSeller    Order[]     @relation("SellerOrders")
  auditLogs         AuditLog[]
  
  // Profile Relations
  labourProfile     LabourProfile?
  transporterProfile TransporterProfile?
  transportTrips    TransportTrip[]    @relation("FarmerTrips")
  
  // Performance Indexes (10x faster queries)
  @@index([role])                    // Fast role filtering
  @@index([isVerified])             // Fast verification checks
  @@index([role, isVerified])       // Composite for role + verified queries
  @@index([createdAt])              // Fast sorting by creation date
  @@index([phoneNumber, role])      // Fast auth queries
}

model LabourProfile {
  id             String   @id @default(uuid())
  user           User     @relation(fields: [userId], references: [id])
  userId         String   @unique
  skills         String[] // e.g., ["Harvesting", "Ploughing"]
  experience     String?
  pricePerDay    Decimal  @db.Decimal(10, 2)
  workPreference String   @default("Day") // Day, Night, Both
  isAvailable    Boolean  @default(true)
  rating         Float    @default(0)
  jobsCompleted  Int      @default(0)
  callsReceived  Int      @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  // Performance Indexes
  @@index([isAvailable])           // Fast availability filtering
  @@index([rating])                // Fast sorting by rating
  @@index([isAvailable, rating])   // Composite for available + top rated
}

model TransporterProfile {
  id              String    @id @default(uuid())
  user            User      @relation(fields: [userId], references: [id])
  userId          String    @unique
  businessName    String?
  operatingRadius Int       @default(50) // in km
  experience      String?
  vehicles        Vehicle[]
  trips           TransportTrip[]
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

model TransportTrip {
  id              String             @id @default(uuid())
  transporter     TransporterProfile @relation(fields: [transporterId], references: [id])
  transporterId   String
  farmer          User?              @relation("FarmerTrips", fields: [farmerId], references: [id])
  farmerId        String?
  farmerName      String
  farmerPhone     String
  pickupLocation  String
  dropLocation    String
  loadType        String?
  vehicleType     String
  date            DateTime
  status          String             @default("pending") // pending, accepted, rejected, completed
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  
  // Performance Indexes
  @@index([transporterId])          // Fast transporter lookup
  @@index([farmerId])               // Fast farmer lookup
  @@index([status])                 // Fast status filtering
  @@index([date])                   // Fast date sorting
  @@index([transporterId, status])  // Transporter's active trips
  @@index([farmerId, status])       // Farmer's active trips
}

model Vehicle {
  id           String             @id @default(uuid())
  transporter  TransporterProfile @relation(fields: [transporterId], references: [id])
  transporterId String
  type         String             // e.g., "Tractor", "Truck"
  model        String
  numberPlate  String?
  capacity     String?            // e.g., "5 Tons"
  ratePerKm    Decimal?           @db.Decimal(10, 2)
  isAvailable  Boolean            @default(true)
  images       String[]
  
  // Driver Info
  driverName    String?
  driverPhone   String?
  driverLicense String?
  
  // Subscription Plan
  plan          String?            // monthly, quarterly, yearly
  expiryDate    DateTime?
  
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
}

model Machine {
  id             String        @id @default(uuid())
  owner          User          @relation(fields: [ownerId], references: [id])
  ownerId        String
  category       String
  brand          String
  model          String
  yearOfPurchase Int
  listingType    ListingType   @default(SELL)
  price          Decimal       @db.Decimal(10, 2)
  rentUnit       String?       // HOURLY, DAILY
  images         String[]
  status         ListingStatus @default(AVAILABLE)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  orders         Order[]
  
  // Performance Indexes
  @@index([status])                      // Fast status filtering
  @@index([listingType])                 // Fast type filtering (SELL/RENT)
  @@index([category])                    // Fast category filtering
  @@index([status, listingType])         // Composite for available listings
  @@index([category, status])            // Category + status queries
  @@index([price])                       // Fast price sorting
  @@index([createdAt])                   // Latest listings
  @@index([ownerId])                     // Fast owner lookup
}

model Order {
  id                   String   @id @default(uuid())
  buyer                User     @relation("BuyerOrders", fields: [buyerId], references: [id])
  buyerId              String
  seller               User     @relation("SellerOrders", fields: [sellerId], references: [id])
  sellerId             String
  machine              Machine? @relation(fields: [machineId], references: [id])
  machineId            String?
  amount               Decimal  @db.Decimal(10, 2)
  paymentStatus        String   @default("PENDING") // PENDING, PAID, FAILED
  gatewayTransactionId String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String?
  user      User?    @relation(fields: [userId], references: [id])
  action    String   // e.g., "VIEW_PII", "UPDATE_PROFILE", "DELETE_ACCOUNT"
  resource  String   // e.g., "User", "Order"
  details   Json?    // Stores what was changed or accessed
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
}
